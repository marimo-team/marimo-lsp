name: Release

on:
  workflow_dispatch:
    inputs:
      pre-release:
        description: "Release as pre-release"
        required: true
        default: false
        type: boolean
      version-bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          # Not yet...
          # - major

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  # Phase 1: Bump version (runs once before platform builds)
  version-bump:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: extension/package.json

      - name: Bump version, commit & push
        working-directory: extension
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          pnpm version ${{ inputs.version-bump }} --no-git-tag-version
          git add package.json
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            git commit -m "v$(cat package.json | jq -r '.version') (pre-release)"
          else
            git commit -m "v$(cat package.json | jq -r '.version')"
          fi
          git push origin HEAD:main

      - name: Output version
        id: version
        working-directory: extension
        run: echo "version=$(cat package.json | jq -r '.version')" >> $GITHUB_OUTPUT

  # Phase 2: Build platform-specific extensions
  build:
    needs: version-bump
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            code-target: win32-x64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            code-target: win32-arm64
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            code-target: linux-x64
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            code-target: linux-arm64
            arch: aarch64
          - os: ubuntu-22.04
            target: arm-unknown-linux-gnueabihf
            code-target: linux-armhf
            arch: armv7
          - os: macos-latest
            target: x86_64-apple-darwin
            code-target: darwin-x64
          - os: macos-14
            target: aarch64-apple-darwin
            code-target: darwin-arm64
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            code-target: alpine-x64
            arch: x86_64
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            code-target: alpine-arm64
            arch: aarch64

    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          path: marimo-lsp
          ref: main  # Get the version-bumped commit

      - name: Read marimo version
        id: marimo-version
        run: echo "ref=$(cat marimo-lsp/.marimo-version)" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: marimo-team/marimo
          ref: ${{ steps.marimo-version.outputs.ref }}
          path: marimo

      # Install Python for bundling the uv binary.
      #
      # Why pip instead of uv? We use `pip install -t` to download the uv wheel
      # and extract the binary to bundle in the extension. While we could use
      # `uv pip install --target`, some builds run in emulated environments
      # (ARM Linux via QEMU, Alpine via chroot) where setting up uv adds
      # complexity. Using pip everywhere keeps the workflow simple and consistent.
      # The speed difference is negligible for a single package install.
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # macOS ARM - use arch prefix to ensure we get the ARM wheel
      - name: Install uv binary (macOS ARM)
        if: ${{ startsWith(matrix.os, 'macos') && startsWith(matrix.target, 'aarch64') }}
        run: arch -arm64 python -m pip install -t ./marimo-lsp/extension/bundled/libs --implementation py --no-deps --require-hashes -r ./marimo-lsp/extension/requirements.txt

      # macOS x64 - use arch prefix to ensure we get the x64 wheel (runs under Rosetta)
      - name: Install uv binary (macOS x64)
        if: ${{ startsWith(matrix.os, 'macos') && startsWith(matrix.target, 'x86_64') }}
        run: arch -x86_64 python -m pip install -t ./marimo-lsp/extension/bundled/libs --implementation py --no-deps --require-hashes -r ./marimo-lsp/extension/requirements.txt

      # Linux ARM - emulated via QEMU, pip runs inside and sees ARM architecture
      - name: Install uv binary (Linux ARM)
        if: ${{ startsWith(matrix.os, 'ubuntu') && !startsWith(matrix.target, 'x86_64') && !endsWith(matrix.target, 'musl') }}
        uses: uraimo/run-on-arch-action@v3.0.1
        with:
          arch: ${{ matrix.arch }}
          distro: ubuntu20.04
          install: |
            apt-get update
            apt-get install -y --no-install-recommends python3 python3-pip
            pip3 install -U pip
          run: |
            python3 -m pip install -t ./marimo-lsp/extension/bundled/libs --implementation py --no-deps --require-hashes -r ./marimo-lsp/extension/requirements.txt

      # Alpine - emulated via chroot (+ QEMU for ARM), pip runs inside and sees musl
      - name: Setup Alpine
        if: ${{ startsWith(matrix.os, 'ubuntu') && endsWith(matrix.target, 'musl') }}
        uses: jirutka/setup-alpine@v1.4.1
        with:
          arch: ${{ matrix.arch }}

      - name: Install uv binary (Alpine)
        if: ${{ startsWith(matrix.os, 'ubuntu') && endsWith(matrix.target, 'musl') }}
        shell: alpine.sh --root {0}
        run: |
          apk add --no-cache python3 py3-pip
          python3 -m pip install -t ./marimo-lsp/extension/bundled/libs --implementation py --no-deps --require-hashes -r ./marimo-lsp/extension/requirements.txt

      # Windows and Linux x64 - native builds, straightforward pip install
      - name: Install uv binary (Windows/Linux x64)
        if: ${{ !startsWith(matrix.os, 'macos') && !(startsWith(matrix.os, 'ubuntu') && !startsWith(matrix.target, 'x86_64') && !endsWith(matrix.target, 'musl')) && !(startsWith(matrix.os, 'ubuntu') && endsWith(matrix.target, 'musl')) }}
        run: python -m pip install -t ./marimo-lsp/extension/bundled/libs --implementation py --no-deps --require-hashes -r ./marimo-lsp/extension/requirements.txt

      # Verify the bundled binary was installed correctly
      - name: Verify uv binary
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            ls -la ./marimo-lsp/extension/bundled/libs/bin/uv.exe
            # Only run version check on native builds (not cross-compiled)
            if [ "${{ matrix.code-target }}" = "win32-x64" ]; then
              ./marimo-lsp/extension/bundled/libs/bin/uv.exe --version
            fi
          else
            ls -la ./marimo-lsp/extension/bundled/libs/bin/uv
            # Only run version check on native builds (not cross-compiled ARM/Alpine)
            if [ "${{ matrix.code-target }}" = "darwin-arm64" ] || [ "${{ matrix.code-target }}" = "darwin-x64" ] || [ "${{ matrix.code-target }}" = "linux-x64" ]; then
              ./marimo-lsp/extension/bundled/libs/bin/uv --version
            fi
          fi

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: marimo-lsp/extension/package.json

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          cache-dependency-path: |
            marimo/pnpm-lock.yaml
            marimo-lsp/extension/pnpm-lock.yaml

      - name: Build marimo packages
        run: |
          cd marimo
          pnpm --recursive --filter "./packages/*" codegen
          pnpm --recursive --filter "./packages/*" build

      - name: Install packages and build extension
        working-directory: marimo-lsp/extension
        run: |
          pnpm install
          pnpm build
          # Use the bundled uv binary for building the sdist
          if [ "$RUNNER_OS" = "Windows" ]; then
            export UV_BINARY="./bundled/libs/bin/uv.exe"
          else
            export UV_BINARY="./bundled/libs/bin/uv"
          fi
          pnpm embed-sdist

      - name: Package extension
        working-directory: marimo-lsp/extension
        shell: bash
        run: |
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            npx vsce package -o ./dist/marimo-${{ matrix.code-target }}.vsix --target ${{ matrix.code-target }} --pre-release
          else
            npx vsce package -o ./dist/marimo-${{ matrix.code-target }}.vsix --target ${{ matrix.code-target }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: marimo-lsp/extension/dist/

  # Phase 3: Build universal extension (fallback for unsupported platforms)
  build-universal:
    needs: version-bump
    runs-on: ubuntu-latest
    name: Build (universal)

    steps:
      - uses: actions/checkout@v4
        with:
          path: marimo-lsp
          ref: main

      - name: Read marimo version
        id: marimo-version
        run: echo "ref=$(cat marimo-lsp/.marimo-version)" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: marimo-team/marimo
          ref: ${{ steps.marimo-version.outputs.ref }}
          path: marimo

      - uses: astral-sh/setup-uv@v6

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: marimo-lsp/extension/package.json

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          cache-dependency-path: |
            marimo/pnpm-lock.yaml
            marimo-lsp/extension/pnpm-lock.yaml

      - name: Build marimo packages
        run: |
          cd marimo
          pnpm --recursive --filter "./packages/*" codegen
          pnpm --recursive --filter "./packages/*" build

      - name: Install packages and build extension
        working-directory: marimo-lsp/extension
        run: |
          pnpm install
          pnpm build
          pnpm embed-sdist

      # NOTE: No pip install for uv - this is the universal fallback without bundled binary

      - name: Package universal extension
        working-directory: marimo-lsp/extension
        run: |
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            npx vsce package -o ./dist/marimo-universal.vsix --pre-release
          else
            npx vsce package -o ./dist/marimo-universal.vsix
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-universal
          path: marimo-lsp/extension/dist/

  # Phase 4: Publish to marketplaces
  publish:
    needs: [version-bump, build, build-universal]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          path: marimo-lsp

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -al ./dist

      - name: Install vsce and ovsx
        run: npm install -g @vscode/vsce ovsx

      - name: Publish to VS Code Marketplace
        run: |
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ./dist/*.vsix --pre-release
          else
            vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ./dist/*.vsix
          fi

      - name: Publish to Open VSX Registry
        run: |
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            ovsx publish --pat ${{ secrets.OPEN_VSX_TOKEN }} --packagePath ./dist/*.vsix --pre-release
          else
            ovsx publish --pat ${{ secrets.OPEN_VSX_TOKEN }} --packagePath ./dist/*.vsix
          fi

      - uses: astral-sh/setup-uv@v6

      - name: Get previous tag
        working-directory: marimo-lsp
        run: |
          echo "PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 1)" >> $GITHUB_ENV

      - name: Generate release notes
        working-directory: marimo-lsp
        run: |
          uv run scripts/generate_release_notes.py "$PREVIOUS_TAG" "${{ needs.version-bump.outputs.version }}" > release_notes.md
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        run: |
          gh release create ${{ needs.version-bump.outputs.version }} \
            --repo ${{ github.repository }} \
            --notes-file marimo-lsp/release_notes.md \
            ./dist/*.vsix
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Notify Slack - Release Success
        if: success() && github.event.pull_request.head.repo.fork == false
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_RELEASES }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "✅ Release completed successfully for vscode-marimo",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *Release successful*\n\n*Repository:* vscode-marimo\n*Version:* ${{ needs.version-bump.outputs.version }}\n*Platforms:* darwin-arm64, darwin-x64, linux-x64, linux-arm64, linux-armhf, alpine-x64, alpine-arm64, win32-x64, win32-arm64, universal\n*URL:* https://marketplace.visualstudio.com/items?itemName=marimo-team.vscode-marimo"
                  }
                }
              ]
            }

      - name: Notify Slack - Release Failed
        if: failure() && github.event.pull_request.head.repo.fork == false
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_RELEASES }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "❌ Release failed for vscode-marimo",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *Release failed*\n\n*Repository:* vscode-marimo\n*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Branch:* ${{ github.ref_name }}\n*Triggered by:* ${{ github.actor }}\n*Workflow:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                  }
                }
              ]
            }
